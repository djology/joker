详解Linux中的虚拟文件系统

        虚拟文件系统是一种神奇的抽象，使得“一切皆文件”哲学在Linux中成为可能

        文件系统是一个遵循特定结构的数据的分层存储

    文件系统基础概念

        Linux内核要求文件系统必须是实体，必须在持久对象上实现open()，read()，write()方法
        从面向对象编程的角度看，内核将通用文件系统视为一个抽象接口，这三大函数是“虚拟”的，没有默认定义
        因此，内核的默认文件系统实现被称为虚拟文件系统（VFS）

        VFS是类Unix系统中“一切皆文件”的基础

        VFS的抽象使Linux用户可以轻松地将文件复制到外部操作系统或抽象实体，无需担心其内部数据格式

        属于VFS基本类型的函数定义本身可以在内核源代码的fs/*.c文件中找到，fs的子目录中包含特定的文件系统
        内核中还包含类似文件系统的实体，在引导过程的早期需要

        VFS是个“垫片层”，位于系统调用和特定 file_operations 的实现之间。file_operations 函数可以与特定
        设备的驱动程序或内存访问器进行通信

        VFS的存在促进了代码重用，因为与文件系统相关的基本方法不需要由每种文件系统类型重新实现

    /tmp：一个小提示

        找出系统中存在的VFS的简单方法是键入 mount | grep -v sd | grep -v :/，在大多数计算机上，它将列出所有
        未驻留在磁盘上，同时也不是VFS的已挂载文件系统。其中一个列出的VFS挂载是 /tmp

        为什么把 /tmp 留在存储设备上是不可取的?
        因为 /tmp 中的文件是临时的，并且存储设备比内存慢，所以创建了 tmpfs 这种文件系统。此外，相较内存，
        物理设备频繁写入更容易磨损。最后，/tmp 中的文件可能包含敏感文件，因此需要在每次重新启动时消失

        不幸的是，默认情况下，某些Linux发行版本的安装脚本仍会在存储设备上创建 /tmp
        tmpfs是一个临时文件系统，位于内存和或交换分区中，将目录安装为tmpfs可以加快访问其文件或确保其内容
        在重新启动时自动清除的有效方法

    /proc 和 /sys

        除了 /tmp 之外，大多数Linux用户最熟悉的VFS是 /proc 和 /sys（/dev依赖共享内存，没有 file_operations
        结构 ）

        procfs 为用户空间提供内核及其控制的进程的瞬时状态的快照。在 /proc 中，内核发布有关其提供的设施的信息，
        如中断、虚拟内存和调度程序

        /proc 文件的行为说明了VFS可以与磁盘上的文件系统不同。一方面，/proc/meminfo 包含了可由命令free展现
        出来的信息，另一方面，它还是空的。事实是当进程从 /proc 请求数据时内核再收集有关内存的统计信息，没有人
        查看时，/proc 中的文件实际上没有任何内容。所以procfs的空文件是有道理的，因为可用的信息是动态的

        procfs只有一个不可为空的文件，即导出的内核配置，每次启动都需要生成一次。/sys 有许多大一些的文件，其中
        大多数由一页内存组成。

        sysfs的目的是将内核称为“kobject”的可读写属性公开给用户空间。kobject的唯一目的是引用计数：当删除对
        kobject的最后一个引用时，系统将回收与之关联的资源。/sys 构成了内核著名的“到用户空间的稳定ABI”，它的
        大部分内容在任何情况下都没有人能“破坏”，但这并不能意味着sysfs中的文件是静态的

        内核的稳定ABI限制了 /sys 中可能出现的内容，而不是任何既定时刻实际存在的内容。列出sysfs中文件的权限可以
        了解如何配置或读取设备、模块、文件系统等可配置、可调参数

    用eBPF和bcc工具一窥VFS内部

        了解内核如何管理sysfs文件的最简单方法是观察它的运行情况，在ARM64或x86_64上观看的最简单方法是使用eBPF
        eBPF（扩展的伯克利数据包过滤器）由在内核中运行的虚拟机组成，特权用户可以从命令行进行查询

    只读根文件系统使得嵌入式设备成为可能

        没有人通过拔插电源插头来关闭服务器或桌面系统，因为物理存储设备上挂载的文件系统可能有挂起状态，且记录状态
        的数据结构可能与写入存储器的内容不同步，所以在最坏的情况下，可能会丢失数据

        物联网和嵌入式设备运行Linux的主机设备的电源会不断断充电，当引擎最终开始运行时，系统如何在长时间fsck的状态
        下启动，答案就是嵌入式设备依赖于只读根文件系统（简称ro-rootfs）




    VFS

        虚拟文件系统（Virtual File System，简称VFS）是Linux内核的子系统之一，为用户程序提供文件和文件系统
        操作的统一接口，屏蔽不同文件系统的差异和操作细节